name: HDOS CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-run-ngrok:
    runs-on: ubuntu-latest

    env:
      PORT: 5000

    steps:
      # ---------- CHECKOUT ----------
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ---------- NODE 24 ----------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      # ---------- INSTALL ----------
      - name: Install Dependencies
        run: npm install

      # ---------- SETUP.SH ----------
      - name: Run setup.sh
        run: |
          chmod +x setup.sh
          ./setup.sh

      # ---------- INSTALL NGROK ----------
      - name: Install ngrok
        run: |
          sudo apt update
          sudo apt install -y curl unzip
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc \
            | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" \
            | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update
          sudo apt install ngrok

      # ---------- CONFIG NGROK TOKEN ----------
      - name: Configure ngrok Token
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          if [ -z "$NGROK_AUTH_TOKEN" ]; then
            echo "âŒ NGROK_AUTH_TOKEN missing in GitHub Secrets"
            exit 1
          fi
          ngrok config add-authtoken "$NGROK_AUTH_TOKEN"

      # ---------- START DEV SERVER BACKGROUND ----------
      - name: Start Dev Server
        run: |
          echo "Starting dev server..."
          nohup npm run dev > dev.log 2>&1 &
          sleep 25
          echo "Dev server started"

      # ---------- START NGROK BACKGROUND ----------
      - name: Start ngrok Tunnel Port 5000
        run: |
          echo "Starting ngrok..."
          nohup ngrok http 5000 > ngrok.log 2>&1 &
          sleep 15
          echo "Ngrok running. Tunnel info:"
          curl http://127.0.0.1:4040/api/tunnels || true

      # ---------- KEEP WORKFLOW ALIVE ----------
      - name: Keep Workflow Alive (Demo Only)
        run: |
          echo "Keeping workflow alive for demo..."
          sleep 7200
