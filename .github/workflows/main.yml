name: HDOS CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-run-ngrok:
    runs-on: ubuntu-latest

    env:
      PORT: 5000

    steps:
      # -------- Checkout Code --------
      - name: Checkout Repository
        uses: actions/checkout@v4

      # -------- Setup Node 24 --------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      # -------- Install Dependencies --------
      - name: Install Dependencies
        run: npm install

      # -------- Run setup.sh --------
      - name: Run setup.sh (DB + App Setup)
        run: |
          chmod +x setup.sh
          ./setup.sh

      # -------- Install ngrok --------
      - name: Install ngrok
        run: |
          sudo apt update
          sudo apt install -y unzip curl
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc \
            | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" \
            | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update
          sudo apt install ngrok

      # -------- Add ngrok Token (IMPORTANT) --------
      - name: Setup ngrok Auth Token
        run: |
          if [ -z "${{ secrets.NGROK_AUTH_TOKEN }}" ]; then
            echo "NGROK TOKEN MISSING"
            exit 1
          fi
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      # -------- Start App --------
      - name: Start Server
        run: |
          npm start &
          sleep 20

      # -------- Start ngrok Tunnel --------
      - name: Start ngrok Tunnel (Port 5000)
        run: |
          ngrok http 5000 > ngrok.log &
          sleep 10
          curl http://127.0.0.1:4040/api/tunnels || true
          sleep 1111
